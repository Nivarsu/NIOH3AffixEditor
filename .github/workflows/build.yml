name: Final Custom Build

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 1. 使用 CMake 编译 C++ 核心库
      - name: Build Native Core (C++ via CMake)
        run: |
          cd Nioh3AffixCore
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      # 2. 编译 C# UI (修正了文件大小写名称)
      - name: Build UI (C#)
        run: |
          dotnet publish Nioh3AffixEditor.csproj -c Release -r win-x64 --self-contained true -o ./final_build

      # 3. 收集所有必要文件
      - name: Prepare Package
        run: |
          # 找到 CMake 编译出的 DLL 并移动到发布目录
          $dll = Get-ChildItem -Recurse -Filter "Nioh3AffixCore.dll" | Select-Object -First 1
          if ($dll) {
            Write-Host "Found DLL: $($dll.FullName)"
            Copy-Item $dll.FullName -Destination ./final_build/
          } else {
            Write-Error "DLL not found!"
            exit 1
          }

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: NIOH3Editor-Ready
          path: ./final_build
