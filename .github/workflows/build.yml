name: Build Fixed

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 1. 编译 C++ 核心库 (已修复拼写错误)
      - name: Build Native Core (C++)
        run: |
          # 搜索 .vcxproj 文件
          $vpc = Get-ChildItem -Recurse -Filter "Nioh3AffixCore.vcxproj" | Select-Object -First 1
          if ($vpc) {
             Write-Host "Found C++ Project: $($vpc.FullName)"
             msbuild $($vpc.FullName) /p:Configuration=Release /p:Platform=x64
          } else {
             Write-Error "Error: Could not find Nioh3AffixCore.vcxproj"
             exit 1
          }

      # 2. 编译 C# UI 并指定输出目录
      - name: Build UI (C#)
        run: |
          # 搜索 .csproj 文件
          $csproj = Get-ChildItem -Recurse -Filter "Nioh3AffixEditor.csproj" | Select-Object -First 1
          if ($csproj) {
             Write-Host "Found C# Project: $($csproj.FullName)"
             # 直接输出到根目录下的 final_build 文件夹，方便查找
             dotnet publish $($csproj.FullName) -c Release -r win-x64 --self-contained true -o ./final_build
          } else {
             Write-Error "Error: Could not find Nioh3AffixEditor.csproj"
             exit 1
          }

      # 3. 查找并复制 C++ 编译好的 DLL
      - name: Copy Native DLL
        run: |
          # 在整个目录下寻找刚刚编译出来的 Nioh3AffixCore.dll
          $dll = Get-ChildItem -Recurse -Filter "Nioh3AffixCore.dll" | Where-Object { $_.FullName -like "*Release*" } | Select-Object -First 1
          
          if ($dll) {
            Write-Host "Copying $($dll.FullName) to final_build..."
            Copy-Item $dll.FullName -Destination ./final_build/
          } else {
            Write-Error "Error: Nioh3AffixCore.dll not found! C++ build may have failed."
            exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NIOH3Editor-Final
          path: ./final_build
